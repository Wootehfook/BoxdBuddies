name: Version Bump and Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      release_notes:
        description: 'Additional release notes (optional)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  version-bump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: npm ci

      - name: Get current version
        id: current_version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Bump version
        id: bump_version
        run: |
          npm version ${{ github.event.inputs.version_type }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Extract unreleased changes from CHANGELOG
        id: extract_changelog
        run: |
          # Validate CHANGELOG.md exists
          if [ ! -f CHANGELOG.md ]; then
            echo "Error: CHANGELOG.md file not found"
            exit 1
          fi
          
          # Validate basic CHANGELOG structure
          if ! grep -q "## \[Unreleased\]" CHANGELOG.md; then
            echo "Warning: CHANGELOG.md does not contain an [Unreleased] section"
            echo "Creating a default unreleased entry..."
            echo "### Changes" > /tmp/unreleased.md
            echo "" >> /tmp/unreleased.md
            echo "- Version bump to ${{ steps.bump_version.outputs.new_version }}" >> /tmp/unreleased.md
          else
            # Extract unreleased section from CHANGELOG.md
            awk '
            /## \[Unreleased\]/ { in_unreleased=1; next }
            in_unreleased && /^## \[/ { exit }
            in_unreleased { print }
            ' CHANGELOG.md > /tmp/unreleased.md

            # Check if there are any changes
            if [ ! -s /tmp/unreleased.md ]; then
              echo "No unreleased changes found in CHANGELOG.md"
              echo "### Changes" > /tmp/unreleased.md
              echo "" >> /tmp/unreleased.md
              echo "- Version bump to ${{ steps.bump_version.outputs.new_version }}" >> /tmp/unreleased.md
            fi
          fi

      - name: Update CHANGELOG.md
        run: |
          DATE=$(date +%Y-%m-%d)
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"

          # Create updated changelog
          {
            echo "# Changelog"
            echo ""
            echo "All notable changes to this project will be documented in this file."
            echo ""
            echo "The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),"
            echo "and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html)."
            echo ""
            echo "## [Unreleased]"
            echo ""
            echo "## [$NEW_VERSION] - $DATE"
            cat /tmp/unreleased.md
            echo ""
            # Append all existing version sections
            awk '/^## \[[0-9]/ { printing=1 } printing { print }' CHANGELOG.md
          } > /tmp/changelog_new.md

          mv /tmp/changelog_new.md CHANGELOG.md

      - name: Update CHANGELOG links
        run: |
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"
          PREV_VERSION="${{ steps.current_version.outputs.version }}"

          # Use temp file approach for better portability across platforms
          # Update version comparison links at the bottom of CHANGELOG
          sed "s|\[Unreleased\]:.*|[Unreleased]: https://github.com/${{ github.repository }}/compare/v${NEW_VERSION}...HEAD|" CHANGELOG.md > CHANGELOG.md.tmp
          mv CHANGELOG.md.tmp CHANGELOG.md

          # Add new version link after Unreleased link using awk for better portability
          awk -v new="[$NEW_VERSION]: https://github.com/${{ github.repository }}/compare/v${PREV_VERSION}...v${NEW_VERSION}" '
          /\[Unreleased\]:/ { print; print new; next }
          { print }
          ' CHANGELOG.md > CHANGELOG.md.tmp
          mv CHANGELOG.md.tmp CHANGELOG.md

      - name: Update package-lock.json
        run: npm install --package-lock-only

      - name: Commit changes
        run: |
          git add package.json package-lock.json CHANGELOG.md
          git commit -m "chore: bump version to ${{ steps.bump_version.outputs.new_version }}"
          git tag ${{ steps.bump_version.outputs.tag }}

      - name: Push changes
        run: |
          git push origin HEAD:${{ github.ref_name }}
          git push origin ${{ steps.bump_version.outputs.tag }}

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_NOTES_FILE=/tmp/release_notes.md

          # Start with the unreleased notes content
          cp /tmp/unreleased.md "$RELEASE_NOTES_FILE"

          # If additional release notes were provided, append them with spacing and a separator
          if [ -n "${{ github.event.inputs.release_notes }}" ]; then
            # Store in variable and sanitize to prevent any command execution
            RELEASE_NOTES=$(printf '%s\n' "${{ github.event.inputs.release_notes }}")
            
            # Enforce a reasonable maximum length to avoid oversized or malformed releases
            MAX_RELEASE_NOTES_LENGTH=5000
            if [ "${#RELEASE_NOTES}" -gt "$MAX_RELEASE_NOTES_LENGTH" ]; then
              echo "Error: release_notes input is too long (${#RELEASE_NOTES} characters). Maximum allowed is $MAX_RELEASE_NOTES_LENGTH." >&2
              exit 1
            fi
            
            {
              echo
              echo '---'
              echo
              printf '%s\n' "$RELEASE_NOTES"
            } >> "$RELEASE_NOTES_FILE"
          fi

          gh release create ${{ steps.bump_version.outputs.tag }} \
            --title "Release ${{ steps.bump_version.outputs.new_version }}" \
            --notes-file "$RELEASE_NOTES_FILE" \
            --target ${{ github.ref_name }}

      - name: Summary
        run: |
          echo "## Version Bump Successful! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Previous Version:** ${{ steps.current_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**New Version:** ${{ steps.bump_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.bump_version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Notes" >> $GITHUB_STEP_SUMMARY
          cat /tmp/unreleased.md >> $GITHUB_STEP_SUMMARY

# AI Generated: GitHub Copilot - 2025-12-26
