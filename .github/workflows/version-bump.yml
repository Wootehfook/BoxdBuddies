name: Version Bump and Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      release_notes:
        description: "Additional release notes (optional)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  version-bump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: "20"
          cache: "npm"

      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config commit.gpgsign true
          git config user.signingkey "${{ steps.import_gpg.outputs.keyid }}"

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Get current version
        id: current_version
        run: |
          if [ ! -r package.json ]; then
            echo "Error: package.json file not found or not readable"
            exit 1
          fi
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Bump version
        id: bump_version
        run: |
          npm version ${{ github.event.inputs.version_type }} --no-git-tag-version
          if [ ! -r package.json ]; then
            echo "Error: package.json file not found or not readable after version bump"
            exit 1
          fi
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Extract unreleased changes from CHANGELOG
        id: extract_changelog
        run: |
          # Validate CHANGELOG.md exists
          if [ ! -f CHANGELOG.md ]; then
            echo "Error: CHANGELOG.md file not found"
            exit 1
          fi

          # Validate basic CHANGELOG structure
          if ! grep -q "## \[Unreleased\]" CHANGELOG.md; then
            echo "Warning: CHANGELOG.md does not contain an [Unreleased] section"
            echo "Creating a default unreleased entry..."
            echo "### Changes" > /tmp/unreleased.md
            echo "" >> /tmp/unreleased.md
            echo "- Version bump to ${{ steps.bump_version.outputs.new_version }}" >> /tmp/unreleased.md
          else
            # Extract unreleased section from CHANGELOG.md
            awk '
            /## \[Unreleased\]/ { in_unreleased=1; next }
            in_unreleased && /^## \[/ { exit }
            in_unreleased { print }
            ' CHANGELOG.md > /tmp/unreleased.md

            # Check if there are any changes
            if [ ! -s /tmp/unreleased.md ]; then
              echo "No unreleased changes found in CHANGELOG.md"
              echo "### Changes" > /tmp/unreleased.md
              echo "" >> /tmp/unreleased.md
              echo "- Version bump to ${{ steps.bump_version.outputs.new_version }}" >> /tmp/unreleased.md
            fi
          fi

      - name: Update CHANGELOG.md
        run: |
          DATE=$(date +%Y-%m-%d)
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"

          # Create updated changelog
          {
            echo "# Changelog"
            echo ""
            echo "All notable changes to this project will be documented in this file."
            echo ""
            echo "The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),"
            echo "and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html)."
            echo ""
            echo "## [Unreleased]"
            echo ""
            echo "## [$NEW_VERSION] - $DATE"
            cat /tmp/unreleased.md
            echo ""
            # Append all existing version sections
            awk '/^## \[[0-9]/ { printing=1 } printing { print }' CHANGELOG.md
          } > /tmp/changelog_new.md

          mv /tmp/changelog_new.md CHANGELOG.md

      - name: Update CHANGELOG links
        run: |
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"
          PREV_VERSION="${{ steps.current_version.outputs.version }}"

          # Use temp file approach for better portability across platforms
          # Update version comparison links at the bottom of CHANGELOG
          sed "s|\[Unreleased\]:.*|[Unreleased]: https://github.com/${{ github.repository }}/compare/v${NEW_VERSION}...HEAD|" CHANGELOG.md > CHANGELOG.md.tmp
          mv CHANGELOG.md.tmp CHANGELOG.md

          # Add new version link after Unreleased link using awk for better portability
          awk -v new="[$NEW_VERSION]: https://github.com/${{ github.repository }}/compare/v${PREV_VERSION}...v${NEW_VERSION}" '
          /\[Unreleased\]:/ { print; print new; next }
          { print }
          ' CHANGELOG.md > CHANGELOG.md.tmp
          mv CHANGELOG.md.tmp CHANGELOG.md

      - name: Update package-lock.json
        run: npm install --package-lock-only --ignore-scripts

      - name: Create version bump branch
        id: create_branch
        run: |
          BRANCH_NAME="chore/version-bump/v${{ steps.bump_version.outputs.new_version }}"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Commit changes
        run: |
          git add package.json package-lock.json CHANGELOG.md
          git commit -S -m "chore: bump version to ${{ steps.bump_version.outputs.new_version }}"

      - name: Push version bump branch
        run: |
          git push origin ${{ steps.create_branch.outputs.branch_name }}

      - name: Create Pull Request
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Prepare PR body with release notes
          PR_BODY_FILE=/tmp/pr_body.md

          {
            echo "## Version Bump: ${{ steps.current_version.outputs.version }} â†’ ${{ steps.bump_version.outputs.new_version }}"
            echo ""
            echo "This PR bumps the version from \`${{ steps.current_version.outputs.version }}\` to \`${{ steps.bump_version.outputs.new_version }}\`."
            echo ""
            echo "### Changes"
            echo ""
            cat /tmp/unreleased.md
            
            # If additional release notes were provided, append them
            if [ -n "${{ github.event.inputs.release_notes }}" ]; then
              # Store in variable and sanitize to prevent any command execution
              RELEASE_NOTES=$(printf '%s\n' "${{ github.event.inputs.release_notes }}")
              
              # Enforce a reasonable maximum length
              MAX_RELEASE_NOTES_LENGTH=5000
              if [ "${#RELEASE_NOTES}" -gt "$MAX_RELEASE_NOTES_LENGTH" ]; then
                echo "Error: release_notes input is too long (${#RELEASE_NOTES} characters). Maximum allowed is $MAX_RELEASE_NOTES_LENGTH." >&2
                exit 1
              fi
              
              echo ""
              echo "---"
              echo ""
              echo "### Additional Release Notes"
              echo ""
              printf '%s\n' "$RELEASE_NOTES"
            fi
            
            echo ""
            echo "---"
            echo ""
            echo "**Note:** After this PR is merged, the \"Create GitHub Release\" workflow will automatically create the tag and release."
            echo "If it fails or the tag already exists, check the Actions run and create the release manually if needed."
            echo ""
            echo "- **Tag:** \`${{ steps.bump_version.outputs.tag }}\`"
            echo "- **Target:** \`main\`"
          } > "$PR_BODY_FILE"

          # Create the PR without labels first, then try to add them if they exist
          PR_URL=$(gh pr create \
            --title "chore: bump version to ${{ steps.bump_version.outputs.new_version }}" \
            --body-file "$PR_BODY_FILE" \
            --base main \
            --head ${{ steps.create_branch.outputs.branch_name }})

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

          # Try to add labels if they exist (non-fatal if they don't)
          gh pr edit "$PR_URL" --add-label "release" 2>/dev/null || echo "Note: 'release' label not found"
          gh pr edit "$PR_URL" --add-label "automated" 2>/dev/null || echo "Note: 'automated' label not found"

      - name: Summary
        run: |
          echo "## Version Bump PR Created! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Previous Version:** ${{ steps.current_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**New Version:** ${{ steps.bump_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.create_branch.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** ${{ steps.create_pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A pull request has been created to merge the version bump into main." >> $GITHUB_STEP_SUMMARY
          echo "After the PR is merged, the \"Create GitHub Release\" workflow will automatically create the tag and release." >> $GITHUB_STEP_SUMMARY
          echo "If the release is not created, check the Actions tab for the \"Create GitHub Release\" workflow run to see if it failed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Notes Preview" >> $GITHUB_STEP_SUMMARY
          cat /tmp/unreleased.md >> $GITHUB_STEP_SUMMARY

# AI Generated: GitHub Copilot (GPT-5.2-Codex) - 2026-02-08
