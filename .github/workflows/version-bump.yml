name: Version Bump and Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      release_notes:
        description: "Additional release notes (optional)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  version-bump:
    runs-on: ubuntu-latest
    env:
      RELEASE_PR_TOKEN: ${{ secrets.RELEASE_PR_TOKEN }}
    steps:
      - name: Validate release PR token
        run: |
          if [ -z "$RELEASE_PR_TOKEN" ]; then
            echo "::error::RELEASE_PR_TOKEN secret is required to create PRs that trigger required checks."
            echo "Create a PAT with repo permissions, store it as RELEASE_PR_TOKEN, then re-run."
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
          token: ${{ env.RELEASE_PR_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec # v6.3.0
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Bump version
        id: bump_version
        run: |
          npm version ${{ github.event.inputs.version_type }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Extract unreleased changes from CHANGELOG
        id: extract_changelog
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "Error: CHANGELOG.md not found"
            exit 1
          fi

          if ! grep -q "## \[Unreleased\]" CHANGELOG.md; then
            echo "Warning: No [Unreleased] section found â€” creating default entry"
            echo "### Changes" > /tmp/unreleased.md
            echo "" >> /tmp/unreleased.md
            echo "- Version bump to ${{ steps.bump_version.outputs.new_version }}" >> /tmp/unreleased.md
          else
            awk '
            /## \[Unreleased\]/ { in_unreleased=1; next }
            in_unreleased && /^## \[/ { exit }
            in_unreleased { print }
            ' CHANGELOG.md > /tmp/unreleased.md

            if [ ! -s /tmp/unreleased.md ]; then
              echo "No unreleased changes found"
              echo "### Changes" > /tmp/unreleased.md
              echo "" >> /tmp/unreleased.md
              echo "- Version bump to ${{ steps.bump_version.outputs.new_version }}" >> /tmp/unreleased.md
            fi
          fi

      - name: Update CHANGELOG.md
        run: |
          DATE=$(date +%Y-%m-%d)
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"

          {
            echo "# Changelog"
            echo ""
            echo "All notable changes to this project will be documented in this file."
            echo ""
            echo "The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),"
            echo "and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html)."
            echo ""
            echo "## [Unreleased]"
            echo ""
            echo "## [$NEW_VERSION] - $DATE"
            cat /tmp/unreleased.md
            echo ""
            # Append all existing version sections
            awk '/^## \[[0-9]/ { printing=1 } printing { print }' CHANGELOG.md
          } > /tmp/changelog_new.md

          mv /tmp/changelog_new.md CHANGELOG.md

      - name: Update CHANGELOG links
        run: |
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"
          PREV_VERSION="${{ steps.current_version.outputs.version }}"

          # Update the [Unreleased] comparison link
          sed "s|\[Unreleased\]:.*|[Unreleased]: https://github.com/${{ github.repository }}/compare/v${NEW_VERSION}...HEAD|" CHANGELOG.md > CHANGELOG.md.tmp
          mv CHANGELOG.md.tmp CHANGELOG.md

          # Add new version comparison link after the [Unreleased] link
          awk -v new="[$NEW_VERSION]: https://github.com/${{ github.repository }}/compare/v${PREV_VERSION}...v${NEW_VERSION}" '
          /\[Unreleased\]:/ { print; print new; next }
          { print }
          ' CHANGELOG.md > CHANGELOG.md.tmp
          mv CHANGELOG.md.tmp CHANGELOG.md

      - name: Update package-lock.json
        run: npm install --package-lock-only --ignore-scripts

      - name: Create release branch
        id: create_branch
        run: |
          BRANCH_NAME="release/v${{ steps.bump_version.outputs.new_version }}"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Commit changes
        run: |
          git add package.json package-lock.json CHANGELOG.md
          git commit -m "chore: bump version to ${{ steps.bump_version.outputs.new_version }}"

      - name: Push release branch
        run: |
          git push origin "${{ steps.create_branch.outputs.branch_name }}"

      - name: Create Pull Request
        id: create_pr
        env:
          GH_TOKEN: ${{ env.RELEASE_PR_TOKEN }}
          RELEASE_NOTES_INPUT: ${{ github.event.inputs.release_notes }}
        run: |
          PR_BODY_FILE=/tmp/pr_body.md

          {
            echo "## Version Bump: ${{ steps.current_version.outputs.version }} â†’ ${{ steps.bump_version.outputs.new_version }}"
            echo ""
            echo "This PR bumps the version from \`${{ steps.current_version.outputs.version }}\` to \`${{ steps.bump_version.outputs.new_version }}\`."
            echo ""
            echo "### Changes"
            echo ""
            cat /tmp/unreleased.md

            if [ -n "$RELEASE_NOTES_INPUT" ]; then
              RELEASE_NOTES=$(printf '%s\n' "$RELEASE_NOTES_INPUT")
              MAX_LEN=5000
              if [ "${#RELEASE_NOTES}" -gt "$MAX_LEN" ]; then
                echo "::error::release_notes exceeds ${MAX_LEN} characters"
                exit 1
              fi
              echo ""
              echo "---"
              echo ""
              echo "### Additional Release Notes"
              echo ""
              printf '%s\n' "$RELEASE_NOTES"
            fi

            echo ""
            echo "---"
            echo ""
            echo "**Note:** After this PR is merged, the \"Create GitHub Release\" workflow will automatically create the tag and release."
            echo ""
            echo "- **Tag:** \`${{ steps.bump_version.outputs.tag }}\`"
            echo "- **Target:** \`main\`"
          } > "$PR_BODY_FILE"

          PR_URL=$(gh pr create \
            --title "chore: bump version to ${{ steps.bump_version.outputs.new_version }}" \
            --body-file "$PR_BODY_FILE" \
            --base main \
            --head "${{ steps.create_branch.outputs.branch_name }}")

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

          # Try to add labels (non-fatal if they don't exist)
          gh pr edit "$PR_URL" --add-label "release" 2>/dev/null || true
          gh pr edit "$PR_URL" --add-label "automated" 2>/dev/null || true

      - name: Summary
        run: |
          echo "## Version Bump PR Created! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Previous Version:** ${{ steps.current_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**New Version:** ${{ steps.bump_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.create_branch.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** ${{ steps.create_pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "After the PR is merged, the \"Create GitHub Release\" workflow will automatically create the tag and release." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Notes Preview" >> $GITHUB_STEP_SUMMARY
          cat /tmp/unreleased.md >> $GITHUB_STEP_SUMMARY
